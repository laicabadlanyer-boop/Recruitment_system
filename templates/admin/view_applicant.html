{% extends "admin/_base.html" %}

{% block title %}View Applicant â€¢ J&T Express{% endblock %}

{% block extra_css %}
<style>
    .sidebar-item.active { border-color: #dc2626; background: rgba(220,38,38,.12); }
    .document-card { transition: all 0.2s ease; }
    .document-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
</style>
{% endblock %}

{% block content %}
<header class="card rounded-xl bg-gradient-to-r from-gray-900 via-gray-900 to-black p-6 mb-6">
    <div class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
                <div class="h-12 w-12 rounded-lg bg-red-500/20 flex items-center justify-center">
                    <i class="fas fa-user text-red-400 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Applicant Profile</h1>
                    <p class="text-gray-400 text-sm">View and manage applicant details</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-4 mt-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-envelope text-gray-400 text-sm"></i>
                    <span class="text-gray-300 text-sm">{{ applicant.email }}</span>
                </div>
                {% if applicant.phone_number %}
                <div class="flex items-center gap-2">
                    <i class="fas fa-phone text-gray-400 text-sm"></i>
                    <span class="text-gray-300 text-sm">{{ applicant.phone_number }}</span>
                </div>
                {% endif %}
                <div class="flex items-center gap-2">
                    <i class="fas fa-calendar text-gray-400 text-sm"></i>
                    <span class="text-gray-300 text-sm">Joined {{ applicant.created_at|format_human_datetime if applicant.created_at else 'N/A' }}</span>
                </div>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="{{ url_for('applicants') }}" class="px-4 py-3 rounded-lg border border-gray-700 hover:border-gray-600 hover:bg-gray-800/50 transition-all text-sm font-medium flex items-center gap-2">
                <i class="fas fa-arrow-left"></i>Back to List
            </a>
            {% if documents and (documents.resume|length + documents.letter|length + documents.license|length) > 0 %}
            <button onclick="scrollToDocuments()" class="px-4 py-3 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-sm font-medium flex items-center gap-2">
                <i class="fas fa-file-alt"></i>View Documents
            </button>
            {% endif %}
        </div>
    </div>
</header>

{% if applicant %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Personal Information Card -->
    <div class="lg:col-span-2 card rounded-xl bg-gray-900/80 p-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-lg font-semibold text-white">Personal Information</h2>
            <div class="px-3 py-1 rounded-full bg-gray-800 text-xs font-medium">
                ID: {{ applicant.applicant_id }}
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Full Name</label>
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                            <i class="fas fa-user text-red-400"></i>
                        </div>
                        <p class="text-white font-semibold text-lg">{{ applicant.full_name }}</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Email Address</label>
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                            <i class="fas fa-envelope text-blue-400"></i>
                        </div>
                        <p class="text-white">{{ applicant.email }}</p>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Account Activity</label>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 text-sm">Account Created:</span>
                            <span class="text-white font-medium">{{ applicant.created_at|format_human_datetime if applicant.created_at else 'N/A' }}</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 text-sm">Last Login:</span>
                            <span class="text-white font-medium">
                                {% if applicant.last_login %}
                                    {{ applicant.last_login|format_human_datetime }}
                                {% else %}
                                    <span class="text-gray-400">Never logged in</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                {% if applicant.phone_number %}
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Contact Number</label>
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-lg bg-green-500/10 flex items-center justify-center">
                            <i class="fas fa-phone text-green-400"></i>
                        </div>
                        <p class="text-white">{{ applicant.phone_number }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="card rounded-xl bg-gray-900/80 p-6">
        <h2 class="text-lg font-semibold text-white mb-6">Quick Stats</h2>
        <div class="space-y-4">
            <div class="flex items-center justify-between p-4 rounded-lg bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="h-12 w-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-briefcase text-purple-400 text-lg"></i>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Applications</p>
                        <p class="text-white text-xl font-bold">{{ applications|length if applications else 0 }}</p>
                    </div>
                </div>
            </div>
            
            {% set ns_all = namespace(seen=[]) %}
            {# Count unique documents from documents dict #}
            {% for ftype in ['resume','letter','license'] %}
                {% for d in (documents.get(ftype, []) if documents else []) %}
                    {% set _key = d.resume_id if d.resume_id else (d.file_path ~ '|' ~ d.file_name) %}
                    {% if _key not in ns_all.seen %}
                        {% set _ = ns_all.seen.append(_key) %}
                    {% endif %}
                {% endfor %}
            {% endfor %}
            {# Also include any attachments referenced by applications (avoid double-counting) #}
            {% if attachments_by_application %}
                {% for _app_id, alist in attachments_by_application.items() %}
                    {% for doc in alist %}
                        {% set _key = doc.resume_id if doc.resume_id else (doc.file_path ~ '|' ~ doc.file_name) %}
                        {% if _key not in ns_all.seen %}
                            {% set _ = ns_all.seen.append(_key) %}
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
            <div class="flex items-center justify-between p-4 rounded-lg bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="h-12 w-12 rounded-lg bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-file-pdf text-red-400 text-lg"></i>
                    </div>
                    <div>
                        <p class="text-gray-400 text-sm">Total Documents</p>
                        <p class="text-white text-xl font-bold">{{ ns_all.seen|length }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Applications Section -->
<section class="card rounded-xl bg-gray-900/80 p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-white">Job Applications</h2>
        <span class="px-3 py-1 rounded-full bg-gray-800 text-sm font-medium">
            {{ applications|length if applications else 0 }} application(s)
        </span>
    </div>

    {% if applications and applications|length > 0 %}
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead>
                <tr class="border-b border-gray-800">
                    <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Job Title</th>
                    <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Status</th>
                    <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Applied Date</th>
                    <th class="text-left py-3 px-4 text-gray-400 font-medium text-sm">Attachments</th>
                </tr>
            </thead>
            <tbody>
                {% for app in applications %}
                <tr class="border-b border-gray-800/50 hover:bg-gray-800/30 transition-colors">
                    <td class="py-4 px-4">
                        <div class="text-white font-medium">{{ app.job_title or 'Unassigned' }}</div>
                    </td>
                    <td class="py-4 px-4">
                        {% set status_color = {
                            'pending': 'bg-yellow-500/20 text-yellow-400',
                            'reviewed': 'bg-blue-500/20 text-blue-400',
                            'shortlisted': 'bg-green-500/20 text-green-400',
                            'rejected': 'bg-red-500/20 text-red-400',
                            'hired': 'bg-emerald-500/20 text-emerald-400'
                        } %}
                        <span class="px-3 py-1 rounded-full text-xs font-medium {{ status_color.get(app.status|lower, 'bg-gray-800 text-gray-300') }}">
                            {{ app.status or 'pending'|title }}
                        </span>
                    </td>
                    <td class="py-4 px-4 text-gray-300 text-sm">
                        {{ app.applied_at|format_human_datetime if app.applied_at else 'N/A' }}
                    </td>
                    <td class="py-4 px-4">
                        {% set app_attachments = attachments_by_application.get(app.application_id, []) if attachments_by_application else [] %}
                        {% if app_attachments and app_attachments|length > 0 %}
                        <div class="flex items-center gap-2">
                            <span class="text-gray-400 text-sm">{{ app_attachments|length }}</span>
                            <div class="flex items-center gap-1">
                                {% for doc in app_attachments|slice(3) %}
                                <a href="{{ doc.view_url }}" target="_blank" 
                                   class="h-8 w-8 rounded-lg bg-gray-800 flex items-center justify-center hover:bg-gray-700 transition-colors"
                                   title="{{ doc.file_name }}">
                                    <i class="fas fa-file text-xs text-gray-300"></i>
                                </a>
                                {% endfor %}
                                {% if app_attachments|length > 3 %}
                                <span class="text-gray-400 text-xs">+{{ app_attachments|length - 3 }}</span>
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <span class="text-gray-500 text-sm">No attachments</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-12">
        <div class="h-16 w-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4">
            <i class="fas fa-file-alt text-2xl text-gray-600"></i>
        </div>
        <h3 class="text-gray-400 font-medium mb-2">No applications found</h3>
        <p class="text-gray-500 text-sm">This applicant hasn't applied to any jobs yet.</p>
    </div>
    {% endif %}
</section>

<!-- Documents Section -->
{% set combined_count = ns_all.seen|length if (ns_all is defined) else (
    (documents.resume|length if documents else 0) + (documents.letter|length if documents else 0) + (documents.license|length if documents else 0)
) %}
{% if combined_count and combined_count > 0 %}
<section id="documents-section" class="card rounded-xl bg-gray-900/80 p-6 mb-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-lg font-semibold text-white">Uploaded Documents</h2>
        <span class="px-3 py-1 rounded-full bg-gray-800 text-sm font-medium">
            {{ documents.resume|length + documents.letter|length + documents.license|length }} file(s)
        </span>
    </div>

    {% set file_types = {
        'resume': {'icon': 'fa-file-pdf', 'label': 'Resumes', 'color': 'text-red-400', 'bg_color': 'bg-red-500/20'},
        'letter': {'icon': 'fa-file-lines', 'label': 'Application Letters', 'color': 'text-blue-400', 'bg_color': 'bg-blue-500/20'},
        'license': {'icon': 'fa-id-card', 'label': "Driver's Licenses", 'color': 'text-green-400', 'bg_color': 'bg-green-500/20'}
    } %}

    <div class="space-y-6">
        {% for ftype in ['resume', 'letter', 'license'] %}
        {% set filtered_docs = documents.get(ftype, []) if documents else [] %}
        {% if filtered_docs and filtered_docs|length > 0 %}
        {% set ns = namespace(seen=[]) %}
        <div class="border border-gray-800 rounded-xl overflow-hidden">
            <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-800">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="h-10 w-10 rounded-lg {{ file_types[ftype].bg_color }} flex items-center justify-center">
                            <i class="fas {{ file_types[ftype].icon }} {{ file_types[ftype].color }}"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold">{{ file_types[ftype].label }}</h3>
                            <p class="text-gray-400 text-sm">{{ filtered_docs|length }} file(s)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for doc in filtered_docs %}
                    {% set _key = doc.resume_id if doc.resume_id else (doc.file_path ~ '|' ~ doc.file_name) %}
                    {% if not (_key in ns.seen) %}
                    {% set _ = ns.seen.append(_key) %}
                    <div class="document-card border border-gray-800 rounded-xl p-5 hover:border-gray-700 transition-all">
                        <div class="flex items-start justify-between mb-4">
                            <div class="h-12 w-12 rounded-lg {{ file_types[ftype].bg_color }} flex items-center justify-center">
                                <i class="fas {{ file_types[ftype].icon }} {{ file_types[ftype].color }} text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-400 px-2 py-1 rounded bg-gray-800">
                                {{ doc.file_size }}
                            </span>
                        </div>
                        
                        <h4 class="text-white font-medium mb-2 truncate" title="{{ doc.file_name }}">
                            {{ doc.file_name }}
                        </h4>
                        
                        <p class="text-gray-400 text-xs mb-4">
                            <i class="fas fa-calendar mr-1"></i>
                            Uploaded {{ doc.uploaded_at }}
                        </p>
                        
                        <div class="flex gap-2">
                            <a href="{{ doc.view_url }}" target="_blank" 
                               class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm text-center transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-eye"></i>Preview
                            </a>
                            <a href="{{ doc.download_url }}" 
                               class="flex-1 px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-medium text-sm text-center transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-download"></i>Save
                            </a>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    {# Render any attachments referenced by applications that weren't in `documents` #}
                    {% set extra_attachments = [] %}
                    {% if attachments_by_application %}
                        {% for _app_id, alist in attachments_by_application.items() %}
                            {% for doc in alist %}
                                {% set key = doc.resume_id if doc.resume_id else (doc.file_path ~ '|' ~ doc.file_name) %}
                                {% if ns_all and (key not in ns_all.seen) %}
                                    {% set _ = ns_all.seen.append(key) %}
                                    {% set _ = extra_attachments.append(doc) %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                    {% endif %}

                    {% if extra_attachments and extra_attachments|length > 0 %}
                    <div class="border border-gray-800 rounded-xl overflow-hidden">
                        <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-800">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="h-10 w-10 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                                        <i class="fas fa-file-lines text-yellow-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-white font-semibold">Application Attachments</h3>
                                        <p class="text-gray-400 text-sm">{{ extra_attachments|length }} file(s) from submitted applications</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {% for doc in extra_attachments %}
                                <div class="document-card border border-gray-800 rounded-xl p-5 hover:border-gray-700 transition-all">
                                    <div class="flex items-start justify-between mb-4">
                                        <div class="h-12 w-12 rounded-lg bg-yellow-500/20 flex items-center justify-center">
                                            <i class="fas fa-file-lines text-yellow-400 text-xl"></i>
                                        </div>
                                        <span class="text-xs text-gray-400 px-2 py-1 rounded bg-gray-800">
                                            {{ doc.file_size }}
                                        </span>
                                    </div>
                                    <h4 class="text-white font-medium mb-2 truncate" title="{{ doc.file_name }}">{{ doc.file_name }}</h4>
                                    <p class="text-gray-400 text-xs mb-4"><i class="fas fa-calendar mr-1"></i>Uploaded {{ doc.uploaded_at }}</p>
                                    <div class="flex gap-2">
                                        <a href="{{ doc.view_url }}" target="_blank" class="flex-1 px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm text-center transition-colors flex items-center justify-center gap-2"><i class="fas fa-eye"></i>Preview</a>
                                        <a href="{{ doc.download_url }}" class="flex-1 px-4 py-2.5 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-medium text-sm text-center transition-colors flex items-center justify-center gap-2"><i class="fas fa-download"></i>Save</a>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</section>
{% endif %}

{% else %}
<div class="card rounded-xl bg-gray-900/80 p-12 text-center">
    <div class="h-16 w-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-user-slash text-2xl text-gray-600"></i>
    </div>
    <h3 class="text-gray-400 font-medium text-lg mb-2">Applicant not found</h3>
    <p class="text-gray-500 mb-6">The applicant you're looking for doesn't exist or has been removed.</p>
    <a href="{{ url_for('applicants') }}" class="px-5 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-sm font-medium inline-flex items-center gap-2">
        <i class="fas fa-arrow-left"></i>Back to Applicants
    </a>
</div>
{% endif %}

<script>
function scrollToDocuments() {
    const documentsSection = document.getElementById('documents-section');
    if (documentsSection) {
        documentsSection.scrollIntoView({ behavior: 'smooth' });
        // Add a highlight effect
        documentsSection.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => {
            documentsSection.classList.remove('ring-2', 'ring-red-500');
        }, 2000);
    }
}
</script>
{% endblock %}