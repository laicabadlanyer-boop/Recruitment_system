{% extends "hr/_base.html" %}

{% block title %}View Applicant • J&T Express{% endblock %}

{% block extra_css %}
<style>
    .sidebar-item.active { border-color: #dc2626; background: rgba(220,38,38,.12); }
    .document-card { transition: all 0.2s ease; }
    .document-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .application-card { transition: all 0.2s ease; }
    .application-card:hover { background: rgba(55, 65, 81, 0.3); }
</style>
{% endblock %}

{% block content %}
<header class="card rounded-xl bg-gradient-to-r from-gray-900 via-gray-900 to-black p-4 sm:p-5 md:p-6 mb-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
        <div class="flex-1">
            <div class="flex items-center gap-3 mb-3">
                <div class="h-10 w-10 sm:h-12 sm:w-12 rounded-lg bg-red-500/20 flex items-center justify-center">
                    <i class="fas fa-user text-red-400 text-lg sm:text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl sm:text-2xl md:text-3xl font-bold text-white mb-1">Applicant Profile</h1>
                    <p class="text-gray-400 text-xs sm:text-sm">View and manage applicant details</p>
                </div>
            </div>
            <div class="flex flex-wrap items-center gap-3 sm:gap-4 mt-4">
                <div class="flex items-center gap-2">
                    <i class="fas fa-envelope text-gray-400 text-xs"></i>
                    <span class="text-gray-300 text-xs sm:text-sm">{{ applicant.email }}</span>
                </div>
                {% if applicant.phone_number %}
                <div class="flex items-center gap-2">
                    <i class="fas fa-phone text-gray-400 text-xs"></i>
                    <span class="text-gray-300 text-xs sm:text-sm">{{ applicant.phone_number }}</span>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
            <a href="{{ url_for('hr_applicants') }}" class="px-3 sm:px-4 py-2.5 rounded-lg border border-gray-700 hover:border-gray-600 hover:bg-gray-800/50 transition-all text-xs sm:text-sm font-medium flex items-center justify-center gap-2">
                <i class="fas fa-arrow-left"></i>Back to List
            </a>
            {% if documents and (documents.resume|length + documents.letter|length + documents.license|length) > 0 %}
            <button onclick="scrollToDocuments()" class="px-3 sm:px-4 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-xs sm:text-sm font-medium flex items-center justify-center gap-2">
                <i class="fas fa-file-alt"></i>View Documents
            </button>
            {% endif %}
        </div>
    </div>
</header>

{% if applicant %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6 mb-6">
    <!-- Personal Information Card -->
    <div class="lg:col-span-2 card rounded-xl bg-gray-900/80 p-4 sm:p-5 md:p-6">
        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5">
            <h2 class="text-base sm:text-lg font-semibold text-white mb-2 sm:mb-0">Personal Information</h2>
            <div class="px-3 py-1 rounded-full bg-gray-800 text-xs font-medium">
                ID: {{ applicant.applicant_id }}
            </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Full Name</label>
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-red-500/10 flex items-center justify-center">
                            <i class="fas fa-user text-red-400 text-sm"></i>
                        </div>
                        <p class="text-white font-semibold text-base sm:text-lg">{{ applicant.full_name }}</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Email Address</label>
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-blue-500/10 flex items-center justify-center">
                            <i class="fas fa-envelope text-blue-400 text-sm"></i>
                        </div>
                        <p class="text-white text-sm sm:text-base break-all">{{ applicant.email }}</p>
                    </div>
                </div>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Account Activity</label>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 text-xs sm:text-sm">Account Created:</span>
                            <span class="text-white font-medium text-xs sm:text-sm">
                                {{ applicant.created_at|format_human_datetime if applicant.created_at else 'N/A' }}
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <span class="text-gray-300 text-xs sm:text-sm">Last Login:</span>
                            <span class="text-white font-medium text-xs sm:text-sm">
                                {% if applicant.last_login %}
                                    {{ applicant.last_login|format_human_datetime }}
                                {% else %}
                                    <span class="text-gray-400">Never</span>
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                {% if applicant.phone_number %}
                <div>
                    <label class="block text-xs uppercase tracking-wider text-gray-400 mb-2">Contact Number</label>
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg bg-green-500/10 flex items-center justify-center">
                            <i class="fas fa-phone text-green-400 text-sm"></i>
                        </div>
                        <p class="text-white text-sm sm:text-base">{{ applicant.phone_number }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Stats Card -->
    <div class="card rounded-xl bg-gray-900/80 p-4 sm:p-5 md:p-6">
        <h2 class="text-base sm:text-lg font-semibold text-white mb-5">Quick Stats</h2>
        <div class="space-y-4">
            <div class="flex items-center justify-between p-3 sm:p-4 rounded-lg bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 sm:h-12 sm:w-12 rounded-lg bg-purple-500/20 flex items-center justify-center">
                        <i class="fas fa-briefcase text-purple-400 text-base sm:text-lg"></i>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs sm:text-sm">Applications</p>
                        <p class="text-white text-lg sm:text-xl font-bold">{{ applications|length if applications else 0 }}</p>
                    </div>
                </div>
            </div>
            
            {% if documents %}
            <div class="flex items-center justify-between p-3 sm:p-4 rounded-lg bg-gray-800/50">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 sm:h-12 sm:w-12 rounded-lg bg-red-500/20 flex items-center justify-center">
                        <i class="fas fa-file-pdf text-red-400 text-base sm:text-lg"></i>
                    </div>
                    <div>
                        <p class="text-gray-400 text-xs sm:text-sm">Total Documents</p>
                        <p class="text-white text-lg sm:text-xl font-bold">{{ documents.resume|length + documents.letter|length + documents.license|length }}</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Applications Section -->
{% if applications and applications|length > 0 %}
<section class="card rounded-xl bg-gray-900/80 p-4 sm:p-5 md:p-6 mb-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5">
        <h2 class="text-base sm:text-lg font-semibold text-white mb-2 sm:mb-0">Job Applications</h2>
        <span class="px-3 py-1 rounded-full bg-gray-800 text-xs sm:text-sm font-medium">
            {{ applications|length }} application(s)
        </span>
    </div>

    <div class="space-y-3 sm:space-y-4">
        {% for app in applications %}
        <div class="application-card border border-gray-800 rounded-xl p-3 sm:p-4 hover:border-gray-700 transition-all">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 sm:gap-0 mb-3">
                <div class="flex-1">
                    <h3 class="text-white font-semibold text-sm sm:text-base mb-1">{{ app.job_title or 'Unassigned' }}</h3>
                    <div class="flex flex-wrap items-center gap-2 sm:gap-3 text-xs text-gray-400">
                        <span>Applied: {{ app.applied_at or 'N/A' }}</span>
                        <span class="hidden sm:inline">•</span>
                        <span>Status:</span>
                        {% set status_color = {
                            'pending': 'bg-yellow-500/20 text-yellow-400',
                            'reviewed': 'bg-blue-500/20 text-blue-400',
                            'shortlisted': 'bg-green-500/20 text-green-400',
                            'rejected': 'bg-red-500/20 text-red-400',
                            'hired': 'bg-emerald-500/20 text-emerald-400'
                        } %}
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium {{ status_color.get(app.status|lower, 'bg-gray-800 text-gray-300') }}">
                            {{ app.status or 'pending'|title }}
                        </span>
                    </div>
                </div>
            </div>
            
            {% set app_attachments = attachments_by_application.get(app.application_id, []) if attachments_by_application else [] %}
            {% if app_attachments and app_attachments|length > 0 %}
            <div class="mt-3 pt-3 border-t border-gray-800/50">
                {% set ns_app = namespace(seen=[]) %}
                <div class="flex items-center gap-2 mb-2">
                    <i class="fas fa-paperclip text-gray-400 text-xs"></i>
                    <span class="text-gray-400 text-xs">Attachments ({{ app_attachments|length }}):</span>
                </div>
                <div class="flex flex-wrap gap-2">
                    {% for doc in app_attachments %}
                        {% set _key2 = doc.resume_id if doc.resume_id else (doc.file_path ~ '|' ~ doc.file_name) %}
                        {% if not (_key2 in ns_app.seen) %}
                            {% set _ = ns_app.seen.append(_key2) %}
                            <a href="{{ doc.view_url }}" target="_blank" 
                               class="group px-2 py-1.5 bg-gray-800/60 hover:bg-gray-700 text-white rounded-lg text-xs border border-gray-700 hover:border-gray-600 transition-colors flex items-center gap-1.5"
                               title="{{ doc.file_name }}">
                                <i class="fas fa-file text-gray-400 group-hover:text-blue-400 text-xs"></i>
                                <span class="truncate max-w-[120px] sm:max-w-[150px]">{{ doc.file_name }}</span>
                            </a>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</section>
{% endif %}

<!-- Documents Section -->
{% if documents and (documents.resume|length + documents.letter|length + documents.license|length) > 0 %}
<section id="documents-section" class="card rounded-xl bg-gray-900/80 p-4 sm:p-5 md:p-6 mb-6">
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between mb-5">
        <h2 class="text-base sm:text-lg font-semibold text-white mb-2 sm:mb-0">Uploaded Documents</h2>
        <span class="px-3 py-1 rounded-full bg-gray-800 text-xs sm:text-sm font-medium">
            {{ documents.resume|length + documents.letter|length + documents.license|length }} file(s)
        </span>
    </div>

    {% set file_types = {
        'resume': {'icon': 'fa-file-pdf', 'label': 'Resumes', 'color': 'text-red-400', 'bg_color': 'bg-red-500/20'},
        'letter': {'icon': 'fa-file-lines', 'label': 'Application Letters', 'color': 'text-blue-400', 'bg_color': 'bg-blue-500/20'},
        'license': {'icon': 'fa-id-card', 'label': "Driver's Licenses", 'color': 'text-green-400', 'bg_color': 'bg-green-500/20'}
    } %}

    <div class="space-y-4 sm:space-y-6">
        {% for ftype in ['resume', 'letter', 'license'] %}
        {% set filtered_docs = documents.get(ftype, []) %}
        {% if filtered_docs and filtered_docs|length > 0 %}
        {% set ns = namespace(seen=[]) %}
        <div class="border border-gray-800 rounded-xl overflow-hidden">
            <div class="bg-gray-800/50 px-4 sm:px-5 py-3 border-b border-gray-800">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg {{ file_types[ftype].bg_color }} flex items-center justify-center">
                            <i class="fas {{ file_types[ftype].icon }} {{ file_types[ftype].color }} text-sm sm:text-base"></i>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold text-sm sm:text-base">{{ file_types[ftype].label }}</h3>
                            <p class="text-gray-400 text-xs">{{ filtered_docs|length }} file(s)</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="p-4 sm:p-5">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4">
                    {% for doc in filtered_docs %}
                    {% set _key = doc.resume_id if doc.resume_id else (doc.file_path ~ '|' ~ doc.file_name) %}
                    {% if not (_key in ns.seen) %}
                    {% set _ = ns.seen.append(_key) %}
                    <div class="document-card border border-gray-800 rounded-xl p-3 sm:p-4 hover:border-gray-700 transition-all">
                        <div class="flex items-start justify-between mb-3">
                            <div class="h-8 w-8 sm:h-10 sm:w-10 rounded-lg {{ file_types[ftype].bg_color }} flex items-center justify-center">
                                <i class="fas {{ file_types[ftype].icon }} {{ file_types[ftype].color }} text-base"></i>
                            </div>
                            <span class="text-xs text-gray-400 px-2 py-0.5 rounded bg-gray-800">
                                {{ doc.file_size }}
                            </span>
                        </div>
                        
                        <h4 class="text-white font-medium text-sm mb-2 truncate" title="{{ doc.file_name }}">
                            {{ doc.file_name }}
                        </h4>
                        
                        <p class="text-gray-400 text-xs mb-3">
                            <i class="fas fa-calendar mr-1"></i>
                            Uploaded {{ doc.uploaded_at }}
                        </p>
                        
                        <div class="flex gap-2">
                            {% if doc.view_url %}
                            <a href="{{ doc.view_url }}" target="_blank" 
                               class="flex-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-xs text-center transition-colors flex items-center justify-center gap-1.5">
                                <i class="fas fa-eye text-xs"></i>Preview
                            </a>
                            {% else %}
                            <button type="button" disabled
                                class="flex-1 px-3 py-2 bg-blue-600/40 text-white rounded-lg font-medium text-xs text-center transition-colors flex items-center justify-center gap-1.5 opacity-60 cursor-not-allowed">
                                <i class="fas fa-eye text-xs"></i>Preview
                            </button>
                            {% endif %}

                            {% if doc.download_url %}
                            <a href="{{ doc.download_url }}" 
                               class="flex-1 px-3 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg font-medium text-xs text-center transition-colors flex items-center justify-center gap-1.5">
                                <i class="fas fa-download text-xs"></i>Download
                            </a>
                            {% else %}
                            <button type="button" disabled
                                class="flex-1 px-3 py-2 bg-gray-800/40 text-white rounded-lg font-medium text-xs text-center transition-colors flex items-center justify-center gap-1.5 opacity-60 cursor-not-allowed">
                                <i class="fas fa-download text-xs"></i>Download
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        {% endfor %}
    </div>
</section>
{% endif %}

{% if not applications or applications|length == 0 %}
<div class="card rounded-xl bg-gray-900/80 p-8 text-center mb-6">
    <div class="h-12 w-12 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-file-alt text-xl text-gray-600"></i>
    </div>
    <h3 class="text-gray-400 font-medium text-sm mb-2">No applications found</h3>
    <p class="text-gray-500 text-xs">This applicant hasn't applied to any jobs yet.</p>
</div>
{% endif %}

{% else %}
<div class="card rounded-xl bg-gray-900/80 p-8 sm:p-12 text-center">
    <div class="h-12 w-12 sm:h-16 sm:w-16 rounded-full bg-gray-800 flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-user-slash text-xl sm:text-2xl text-gray-600"></i>
    </div>
    <h3 class="text-gray-400 font-medium text-base sm:text-lg mb-2">Applicant not found</h3>
    <p class="text-gray-500 text-xs sm:text-sm mb-6">The applicant you're looking for doesn't exist or has been removed.</p>
    <a href="{{ url_for('applicants') }}" class="px-4 py-2.5 rounded-lg bg-red-600 hover:bg-red-700 transition-all text-xs sm:text-sm font-medium inline-flex items-center gap-2">
        <i class="fas fa-arrow-left"></i>Back to Applicants
    </a>
</div>
{% endif %}

<script>
function scrollToDocuments() {
    const documentsSection = document.getElementById('documents-section');
    if (documentsSection) {
        documentsSection.scrollIntoView({ behavior: 'smooth' });
        // Add a highlight effect
        documentsSection.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => {
            documentsSection.classList.remove('ring-2', 'ring-red-500');
        }, 2000);
    }
}
</script>
{% endblock %}
